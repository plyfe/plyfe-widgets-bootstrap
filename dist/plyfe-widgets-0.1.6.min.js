/*!
* @license plyfe-widgets Copyright (c) 2014, Plyfe Inc.
* All Rights Reserved.
* Available via the MIT license.
* see: http://github.com/plyfe/plyfe-widgets/LICENSE for details
*/
!function(a,b){"function"==typeof define&&define.amd?define([],b):(a.Plyfe={amd:!1},a.Plyfe=b())}(this,function(){var a,b,c;return function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){return n.apply(d,v.call(arguments,0).concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("../node_modules/almond/almond",function(){}),c("utils",["require","exports","module"],function(){function a(a,b,c){return a.getAttribute("data-"+b)||c}function b(a){var b=[];return d(a||{},function(c){var d=a[c];if(d!==n){var e=encodeURIComponent(j(c));null!==d&&(e+="="+encodeURIComponent(d)),b.push(e)}}),b.join("&")}function c(a,c,d,e,f){switch(a){case"http":d=d&&80!==d?":"+d:"";break;case"https":d=d&&443!==d?":"+d:""}var g=a+"://"+(c||"")+d,h=b(f);return g+=(e?"/"+e:"").replace(/\/{2,}/g,"/"),g+=(h?"?":"")+h}function d(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c])}function e(a,b){if(document.getElementsByClass)return document.getElementsByClassName(a);if(document.querySelectorAll)return document.querySelectorAll("."+a);for(var c=document.getElementsByTagName(b||"*"),d=new RegExp("\\b"+a+"\\b"),e=[],f=0,g=c.length;g>f;f++)d.test(c[f].className)&&e.push(c[f]);return e}function f(a){if(!(a&&"readystatechange"===a.type&&"complete"!==document.readyState||t)){t=!0,r(window,"load",f),r(document,"readystatechange",f),r(document,"DOMContentLoaded",f);for(var b=0;b<s.length;b++)s[b]()}}function g(a){t?a():s.push(a)}function h(a,b){d(b,function(b,c){a.style[b]="number"==typeof c?c+"px":c})}function i(a){return a.toLowerCase().replace(/-(.)/g,function(a,b){return b.toUpperCase()})}function j(a){return a.replace(/([A-Z])/g,function(a,b){return"-"+b.toLowerCase()})}function k(a,b){b=b||{};var c=document.createElement("style");return c.type="text/css",c.media="screen",b.id&&(c.id=b.id),c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),o.insertBefore(c,o.firstChild),c}function l(a){return u+": "+a+";"}function m(a){a=+a||0;for(var b="";b.length<a;)b+=Math.random().toString(36).substring(2);return b.substr(0,a)}var n,o=document.getElementsByTagName("head")[0],p=!1;window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest&&(p=!0);var q=function(a,b,c){a.addEventListener(b,c,!1)};window.attachEvent&&(q=function(a,b,c){var d=c.__attachEventRef=function(){var a=window.event;a.keyCode=a.which,c(a)};a.attachEvent("on"+b,d)});var r=function(a,b,c){a.removeEventListener(b,c,!1)};window.detachEvent&&(r=function(a,b,c){a.detachEvent("on"+b,c.__attachEventRef)});var s=[],t=!1;"complete"===document.readyState?f():(q(window,"load",f),q(document,"readystatechange",f),q(document,"DOMContentLoaded",f));var u=function(){for(var a=document.createElement("div"),b=[null,"Moz","webkit","Webkit","Khtml","O","ms"],c=0;c<b.length;c++){var d=b[c],e=d?d+"Transition":"transition";if("string"==typeof a.style[e])return e}}();return{head:o,dataAttr:a,buildQueryString:b,buildUrl:c,isCorsSupported:p,objForEach:d,getElementsByClassName:e,addEvent:q,removeEvent:r,domReady:g,setStyles:h,dashedToCamel:i,camelToDashed:j,customStyleSheet:k,cssTransition:l,uniqueString:m}}),c("settings",["require","exports","module"],function(){return{api:{scheme:"https",domain:"plyfe.me",port:443,userToken:null},widget:{className:"plyfe-widget"}}}),c("api",["require","exports","module","utils","settings"],function(a){function b(a){return h.buildUrl(i.api.scheme,i.api.domain,i.api.port,a)}function c(a,c,e,f){f=f||{},a=a.toUpperCase();var g=b(c),i=h.isCorsSupported?new XMLHttpRequest:new d;return i.onreadystatechange=function(){if(4===i.readyState)switch(i.status){case 0:throw new Error("Request "+g+" returned an invalid HTTP status of 0.");case 200:case 304:if(f.onSuccess){var a=i.responseText;"string"==typeof a&&(a=JSON.parse(a)),f.onSuccess(a,i.status)}}},"GET"===a&&e&&(g+=(g.indexOf("?")>=0?"&":"?")+h.buildQueryString(e)),i.open(a,g),f.withCredentials&&(i.withCredentials=!0),"POST"===a&&e&&(i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),"object"==typeof e&&(e=h.buildQueryString(e))),i.send(e?e:null),i}function d(a){this.el=document.createElement("script"),this.uniqueCallbackName=a||"plyfeJsonPCallback_"+h.uniqueString(10)}function e(a,b,d){return c.call(null,"get",a,b,d)}function f(a,b,d){return c.call(null,"post",a,b,d)}var g,h=a("utils"),i=a("settings");return d.prototype.setRequestHeader=function(){},d.prototype.open=function(a,b){this.method=a,this.url=b},d.prototype.send=function(a){var b=this;window[this.uniqueCallbackName]=function(a){try{delete window[b.uniqueCallbackName]}catch(c){window[b.uniqueCallbackName]=g}b.responseText=a,b.readyState=4,b.status=a.http_status_code||200,b.onreadystatechange()};var c={callback:this.uniqueCallbackName,http_method:this.method.toUpperCase()};a&&(c.http_data=a),this.el.src=this.url+"?"+h.buildQueryString(c)+"&"+a,h.head.appendChild(this.el),setTimeout(function(){try{h.head.removeChild(b.el)}catch(a){}},200)},{get:e,post:f,JSONPRequest:d,buildApiUrl:b}}),c("dialog",["require","exports","module","utils"],function(a){function b(a,b,e){b=Math.max(Math.min(+b||320,document.documentElement.clientWidth),240),e=Math.max(Math.min(+e||200,document.documentElement.clientWidth),100),c(),f.className="show",h.src=a,d.setStyles(g,{width:b,height:e,marginLeft:b/2})}function c(){f.className="",g.className=""}var d=a("utils"),e="#plyfe-modal-container {position: fixed;top: 0;right: 0;bottom: 0;left: 0;visibility: hidden;background-color: transparent;"+d.cssTransition("background-color 1s, visibility 0s linear 1s")+"}\n#plyfe-modal-container.show {visibility: visible;background-color: rgba(0, 0, 0, 0.5);"+d.cssTransition("background-color 500ms")+"}\n#plyfe-modal-dialog {position: absolute;top: 20%;left: 50%;margin-left: 150px;width: 300px;opacity: 0;border: 1px solid #DDD;border-radius: 5px;background-color: #EEE;"+d.cssTransition("opacity 500ms")+"}#plyfe-modal-dialog.ready {opacity: 1}\n#plyfe-modal-iframe {display: block;width: 100%;height: 100%;border: none;overflow: hidden;margin: 1.5%;}";d.customStyleSheet(e,{id:"plyfe-dialog-css"});var f=document.createElement("div");f.id="plyfe-modal-container";var g=document.createElement("div");g.id="plyfe-modal-dialog",f.appendChild(g);var h=document.createElement("iframe");return h.id="plyfe-modal-iframe",h.allowtransparency="true",h.onload=function(){g.className="ready"},g.appendChild(h),d.domReady(function(){document.body.appendChild(f)}),d.addEvent(f,"mousedown",function(a){a.target===f&&c()}),d.addEvent(document,"keyup",function(a){27===a.keyCode&&c()}),{open:b,close:c}}),c("widget",["require","exports","module","utils","settings"],function(a){function b(a){this.el=a,this.venue=f.dataAttr(a,"venue"),this.type=f.dataAttr(a,"type"),this.id=f.dataAttr(a,"id");var b=f.dataAttr(a,"scheme",g.api.scheme),c=f.dataAttr(a,"domain",g.api.domain),d=f.dataAttr(a,"port",g.api.port);if(!this.venue)throw new Error("data-venue attribute required");if(!this.type)throw new Error("data-type attribute required");if(!this.id)throw new Error("data-id attribute required");var e=["w",this.venue,this.type,this.id],h={theme:g.widget.theme,width:f.dataAttr(a,"width"),maxWidth:f.dataAttr(a,"max-width"),minWidth:f.dataAttr(a,"min-width"),height:f.dataAttr(a,"height"),maxHeight:f.dataAttr(a,"max-height"),minHeight:f.dataAttr(a,"min-height")},j=f.buildUrl(b,c,d,e.join("/"),h),k="plyfe-"+ ++i;this.el.innerHTML='<iframe name="'+k+'" src="'+j+'">',this.iframe=this.el.firstChild}function c(a){if(!a&&3===a.nodeType)throw new Error("createWidget() must be called with a DOM element");(null===a.firstChild||"iframe"!==a.firstChild.nodeName)&&h.push(new b(a))}function d(a){if("iframe"!==a.nodeName&&(a=a.firstChild),a&&"iframe"===a.nodeName)for(var b=h.length-1;b>=0;b--){var c=h[b];c.iframe===a&&(h.splice(b,1),a.parentNode.innerHTML="")}}function e(a){for(var b=h.length-1;b>=0;b--)a(h[b])}var f=a("utils"),g=a("settings"),h=[],i=0,j=".plyfe-widget {opacity: 0;"+f.cssTransition("opacity 300s")+"}\n.plyfe-widget.ready {opacity: 1;"+f.cssTransition("opacity 300ms")+"}\n.plyfe-widget iframe {display: block;width: 100%;height: 100%;border-width: 0;overflow: hidden;}";return f.customStyleSheet(j,{id:"plyfe-widget-css"}),{create:c,distroy:d,list:h,forEach:e}}),c("switchboard",["require","exports","module","utils","dialog","widget"],function(a){function b(a,b,c){if(!b)throw new TypeError("Argument name required");a.postMessage("plyfe:"+b+"\n"+JSON.stringify(c),i)}function c(a){if(window.JSON){var b=a.data,c=a.origin===i&&b.substr(0,h.length)===h;if(c){{var e=b.indexOf("\n",h.length+1),f=b.substr(h.length+1,e),g=JSON.parse(b.substr(e+1));window.frames}d(f,g,a.source)}}}function d(a,c,d){switch(a){case"dialog:open":f.open(c.src,c.width,c.height);break;case"dialog:close":f.close();break;case"sizechanged":g.forEach(function(a){a.iframe===d&&e.setStyles(a.el,{width:c.width,height:c.height})});break;case"pusher":break;case"broadcast":g.forEach(function(e){e.iframe!==d&&b(e.iframe,a,c)});break;default:console.warn("Switchboard recieved a unhandled '"+a+"' message",c)}}var e=a("utils"),f=a("dialog"),g=a("widget"),h="plyfe",i="*";return e.addEvent(window,"message",c),{postMessage:b}}),c("main",["require","exports","module","utils","settings","api","dialog","widget","switchboard"],function(a){function b(a){this.name="PlyfeError",this.message=a||""}function c(){for(var a=f.getElementsByClassName(g.widget.className),b=0;b<a.length;b++)i.create(a[b])}function d(a){return i.create(a)}function e(a){if(!g.api.userToken)throw new b("A userToken must be set before login.");var c={withCredentials:!0};return a&&(c.onSuccess=a),h.post("/external_sessions/",{auth_token:g.api.userToken},c)}var f=a("utils"),g=a("settings"),h=a("api"),i=(a("dialog"),a("widget")),j=(a("switchboard"),"plyfeAsyncInit"),k=!window.Plyfe||window.Plyfe.amd!==!1;b.prototype=Error.prototype;for(var l=document.getElementsByTagName("script"),m=l.length-1;m>=0;m--){var n=l[m];if(/\/plyfe-widgets.*?\.js(\?|#|$)/.test(n.src)){g.api.userToken=f.dataAttr(n,"user-token",null),g.api.scheme=f.dataAttr(n,"scheme",g.api.scheme),g.api.domain=f.dataAttr(n,"domain",g.api.domain),g.api.port=+f.dataAttr(n,"port")||g.api.port,j=f.dataAttr(n,"init-name",j);break}}return k||f.domReady(function(){window[j]&&"function"==typeof window[j]?window[j]():g.api.userToken&&e(function(){c()})}),{settings:g,createWidgets:c,createWidget:d,login:e}}),b("main")});